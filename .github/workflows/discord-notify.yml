name: CI + Notify Discord

on:
  push:
    branches: [main]
    tags: ["v*"] # optional: also notify on version tags
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # Your real build goes here. Example:
      - name: Build
        run: |
          echo "Building..."
          # e.g. npm ci && npm run build
          # simulate failure with: exit 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ success() }}
    steps:
      - name: Deploy
        run: |
          echo "Deploying new version $GITHUB_SHA"
          # replace with your deploy logic (kubectl/helm/etc.)

  notify-success:
    name: Notify Discord (success)
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: ${{ success() && github.ref == 'refs/heads/main' }}
    steps:
      - name: Post success to Discord
        uses: Ilshidur/action-discord@v2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ✅ Deploy succeeded:
            • Repo: ${{ github.repository }}
            • Ref:  ${{ github.ref_name }}
            • Commit: ${{ github.sha }}
            • Author: ${{ github.actor }}
            • Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            • Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}

  notify-failure:
    name: Notify Discord (failure)
    runs-on: ubuntu-latest
    # Depend on both so any failure bubbles here
    needs: [build, deploy]
    if: ${{ failure() }}
    steps:
      - name: Post failure to Discord
        uses: Ilshidur/action-discord@v2
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ❌ Build/Deploy failed:
            • Repo: ${{ github.repository }}
            • Ref:  ${{ github.ref_name }}
            • Commit: ${{ github.sha }}
            • Author: ${{ github.actor }}
            • Message: ${{ github.event.head_commit.message }}
            • Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            • Commit: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
